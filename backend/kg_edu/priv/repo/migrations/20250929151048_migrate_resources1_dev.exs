defmodule KgEdu.Repo.Migrations.MigrateResources1 do
  @moduledoc """
  Updates resources based on their most recent snapshots.

  This file was autogenerated with `mix ash_postgres.generate_migrations`
  """

  use Ecto.Migration

  def up do
    # knowledge_resource_id column already added in previous migration
    # Just ensure the foreign key constraint exists with the correct name
    execute """
    DO $$
    BEGIN
      IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints 
        WHERE constraint_name = 'files_knowledge_resource_id_fkey'
        AND table_name = 'files'
      ) THEN
        ALTER TABLE files ADD CONSTRAINT files_knowledge_resource_id_fkey 
        FOREIGN KEY (knowledge_resource_id) REFERENCES knowledge_resources(id);
      END IF;
    END $$;
    """
  end

  def down do
    # Only drop the constraint if it was added by this migration
    # Don't remove the column as it was added by a previous migration
    execute """
    DO $$
    BEGIN
      IF EXISTS (
        SELECT 1 FROM information_schema.table_constraints 
        WHERE constraint_name = 'files_knowledge_resource_id_fkey'
        AND table_name = 'files'
      ) THEN
        ALTER TABLE files DROP CONSTRAINT files_knowledge_resource_id_fkey;
      END IF;
    END $$;
    """
  end
end
